<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="Beauty Bar Google Docs Gadget"
	     title_url="http://beauty-bar.appspot.com/"
             description="Beauty Bar / Beta version (http://beauty-bar.appspot.com/) is a tool to create nice charts. Beta version does only allow data that have two columns (names and values) and six rows. It also expects that value range is between 0 and 100. Output 300x200 size SVG image, which might not work with all browsers."
             author="Ilpo Stenberg"
             author_affiliation="Beauty Bar"
             author_email="istenber@gmail.com"
             screenshot="http://beauty-bar.appspot.com/images/spreadsheet-image.png"
             thumbnail="http://beauty-bar.appspot.com/images/spreadsheet-thumb.png" >
<Require feature="idi" />
<Require feature="locked-domain" />
</ModulePrefs>
<UserPref name="_table_query_url" display_name="Data source url" 
          required="true"/>
<UserPref name="_table_query_refresh_interval" 
          display_name="Data refresh interval (minutes)" 
          default_value="0" datatype="enum" required="false">
<EnumValue value="0" display_value="Do not refresh"/>
<EnumValue value="60" display_value="1"/>
<EnumValue value="300" display_value="5"/>
<EnumValue value="1800" display_value="30"/>
</UserPref>
<Content type="html"
	 preferred_height="300"
	 preferred_width="200"><![CDATA[

<script type="text/javascript" src="http://beauty-bar.appspot.com/svgweb/svg.js"
	data-path="http://beauty-bar.appspot.com/svgweb"></script>
<script src="http://www.google.com/jsapi" type="text/javascript"></script>

<div id="my_chart" style="overflow: auto;">
Receiving data from <a href="http://beauty-bar.appspot.com" target="_top">http://beauty-bar.appspot.com</a>, please wait.
</div>

<script>

var chart_type = 'test';

var gadgetHelper = null;
_IG_RegisterOnloadHandler(loadVisualizationAPI);
function loadVisualizationAPI() { 
  google.load("visualization", "1");
  google.setOnLoadCallback(sendQuery);
}

function sendQuery() {
  var prefs = new _IG_Prefs();
  gadgetHelper = new google.visualization.GadgetHelper(); 
  var query = gadgetHelper.createQueryFromPrefs(prefs);
  query.send(handleQueryResponse);
} 

function handleQueryResponse(response) {

  if (!gadgetHelper.validateResponse(response)) {
    return;
  }

  var data = response.getDataTable();
  var rows = data.getNumberOfRows();
  var cols = data.getNumberOfColumns();

  if(!((rows == 6) && (cols == 2))) {
    errorMsg('Error: Beauty Bar supports only tables with' +
             'two rows (names and values) and six columns, got ' +
             rows + ' rows and ' + cols + ' columns.');
    return;
  }

  var chart_url = 'http://beauty-bar.appspot.com/chart?cht=' + chart_type;

  chart_url += '&chd=t:';
  for (var row = 0; row < 6; row++) {
    var formattedValue = data.getFormattedValue(row, 1);
    formattedValue = escapeHtml(formattedValue);
    if((formattedValue < 0) || (formattedValue > 100)) {
      errorMsg('Error: Value out of range: ' + formattedValue);
      return;
    }
    chart_url += formattedValue + ',';
  }
  chart_url = chart_url.replace(/,+$/, '');
  chart_url += '&chs=' + document.body.clientWidth + 'x' + document.body.clientHeight;
  chart_url += '&chl=';
  for (var row = 0; row < 6; row++) {
    var formattedValue = data.getFormattedValue(row, 0);
    formattedValue = escapeHtml(formattedValue);
    chart_url += formattedValue + '|';
  }
  chart_url = chart_url.replace(/\|+$/, '');

  var svg_image = document.createElement('object', true);
  svg_image.setAttribute('type', 'image/svg+xml');
  svg_image.setAttribute('data', chart_url);
  svg_image.setAttribute('id', 'o_img');

  var my_chart = _gel('my_chart');
  my_chart.innerHTML = '';
  svgweb.appendChild(svg_image, my_chart);
};

function errorMsg(msg) {
  var my_chart = _gel('my_chart');
  my_chart.innerHTML = msg;
}

function escapeHtml(text) {
  if (text == null) {
    return '';
  }
  return _hesc(text);
} 

</script> 
]]>
</Content>
</Module>
